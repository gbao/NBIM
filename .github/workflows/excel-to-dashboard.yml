name: Excel to NBIM Dashboard

on:
  push:
    branches: [ main ]
    paths: 
      - 'data/excel/**'
      - 'scripts/**'
      - 'templates/**'
  schedule:
    - cron: '0 9 * * 1'  # Weekly Monday 9 AM
  workflow_dispatch:

jobs:
  excel-to-dashboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‚ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        npm install
        
    - name: ðŸ“Š Convert Excel to JSON
      run: |
        echo "ðŸ“Š Converting Excel files to JSON..."
        node scripts/excel-to-json.js
        
    - name: ðŸ” Validate converted data
      run: |
        echo "ðŸ” Validating converted data..."
        node scripts/validate-data.js
      
    - name: ðŸŽ¨ Generate dashboard
      run: |
        echo "ðŸŽ¨ Generating dashboard..."
        node scripts/generate-dashboard.js
        
    - name: ðŸ’¾ Commit updated JSON files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "NBIM Dashboard Bot"
        git add data/json/ || true
        git add public/ || true
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ¤– Auto-update: Excel â†’ Dashboard $(date '+%Y-%m-%d %H:%M')"
          git push
        else
          echo "No changes to commit"
        fi
        
    - name: ðŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        commit_message: 'ðŸš€ Deploy NBIM Dashboard - ${{ github.sha }}'
        
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸŽ‰ NBIM Dashboard Updated Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **â° Updated**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ”— Live URL**: https://gbao.github.io/NBIM" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“Š Data Source**: Excel files in /data/excel/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Files Processed:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ˆ NBIM_Acquisitions.xlsx" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’° NBIM_Cashflow.xlsx" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’± NBIM_ExchangeRates.xlsx" >> $GITHUB_STEP_SUMMARY